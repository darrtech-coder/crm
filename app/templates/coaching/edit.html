{# app/templates/coaching/edit.html #}
{% extends "base.html" %}
{% block content %}

<a href="{{ url_for('coaching.list_plans') }}" class="btn btn-secondary mb-3">&larr; Back to Plans</a>

<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Editâ€¯Coachingâ€¯Plan</h2>
        <form method="POST"
              action="{{ url_for('coaching.delete_plan', plan_id=plan.id) }}"
              onsubmit="return confirm('Deleteâ€¯thisâ€¯planâ€¯permanently?');">
          <button type="submit" class="btn btn-danger">ðŸ—‘â€¯Delete</button>
        </form>
      </div>

      <form method="POST">
        {# ... (keep Title, Description, Due Date, Pass Mark, Assignment fields) ... #}
        <!-- Title -->
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input type="text" class="form-control" name="title"
                 value="{{ plan.title }}" required>
        </div>

        <!-- Description -->
        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea name="description" rows="3"
                    class="form-control">{{ plan.description }}</textarea>
        </div>

        <!-- Due Date -->
        <div class="mb-3">
          <label class="form-label">Dueâ€¯Date</label>
          <input type="date" name="due_date"
                 value="{{ plan.due_date.strftime('%Y-%m-%d') if plan.due_date }}"
                 class="form-control">
          <small class="text-muted">Defaultâ€¯isâ€¯7â€¯daysâ€¯fromâ€¯creationâ€¯ifâ€¯leftâ€¯blank.</small>
        </div>

        <!-- Pass mark -->
        <div class="mb-3">
          <label class="form-label">Passâ€¯Markâ€¯(%)</label>
          <input type="number" name="pass_percent" min="0" max="100"
                 value="{{ plan.pass_percent or 60 }}" class="form-control">
        </div>

        <!-- Assignment -->
        <div class="mb-3">
          <label class="form-label">Assignâ€¯To</label>
          <div class="input-group">
            <div class="position-relative flex-grow-1">
                <input type="text" id="user-search-box" class="form-control" placeholder="Search for a User (optional)">
                <div class="list-group position-absolute w-100" id="user-search-results" style="z-index: 1000; display:none;"></div>
                <input type="hidden" name="assigned_to" id="assigned_to_hidden" value="{{ plan.assigned_to or '' }}">
            </div>
            <span class="input-group-text">or</span>
            <select class="form-select" name="team_id">
              <option value="">--â€¯Assignâ€¯toâ€¯Teamâ€¯--</option>
              {% for t in teams %}
              <option value="{{ t.id }}" {% if plan.team_id==t.id %}selected{% endif %}>{{ t.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div id="selected-user-tag" class="mt-2">
            {% if plan.assignee %}
                <span class="badge bg-primary d-flex align-items-center">
                    {{ plan.assignee.name or plan.assignee.username }} ({{ plan.assignee.email }})
                    <button type="button" class="btn-close ms-2" onclick="removeSingleItem(this, 'selected-user-tag', 'assigned_to_hidden')"></button>
                </span>
            {% endif %}
          </div>
          <div class="form-text">You can assign either to a specific user or to a team.</div>
        </div>

        {# -------------------- [START] Updated Library Items and Tests Section -------------------- #}
        <!-- Attached Library Courses -->
        <div class="mb-3">
            <label class="form-label">Search & Attach Library Items</label>
            <div class="position-relative">
                <input class="form-control" id="courseSearch" placeholder="Type to search libraryâ€¦">
                <div class="list-group position-absolute w-100 shadow-sm" id="courseResult" style="z-index:10; max-height:200px; overflow-y:auto; display:none;"></div>
            </div>
            <div id="selected-courses" class="mt-2 d-flex flex-wrap gap-2">
                {% for c_item in plan.coaching_plan_items %}
                <span class="badge bg-info text-dark d-flex align-items-center">
                    {{ c_item.item.title }}
                    <button type="button" class="btn-close ms-2" onclick="removeItem(this, 'items', {{ c_item.item.id }})"></button>
                    <input type="hidden" name="items" value="{{ c_item.item.id }}">
                </span>
                {% endfor %}
            </div>
        </div>

        <!-- Attach Tests -->
        <div class="mb-3">
            <label class="form-label">Search & Attach Tests</label>
            <div class="position-relative">
                <input class="form-control" id="testSearch" placeholder="Search testsâ€¦">
                <div class="list-group position-absolute w-100 shadow-sm" id="testResult" style="z-index:9; max-height:200px; overflow-y:auto; display:none;"></div>
            </div>
            <div id="selected-tests" class="mt-2 d-flex flex-wrap gap-2">
                {% for t_item in plan.coaching_plan_tests %}
                <span class="badge bg-secondary d-flex align-items-center">
                    {{ t_item.test.title }}
                    <button type="button" class="btn-close ms-2" onclick="removeItem(this, 'tests', {{ t_item.test.id }})"></button>
                    <input type="hidden" name="tests" value="{{ t_item.test.id }}">
                </span>
                {% endfor %}
            </div>
            <small class="text-muted">All required courses linked to these tests will be added automatically.</small>
        </div>
        {# -------------------- [END] Updated Library Items and Tests Section -------------------- #}



<!-- Attach Academy Courses -->
<div class="mb-3">
  <label class="form-label">Search & Attach Academy Courses</label>
  <div class="position-relative">
    <input class="form-control" id="academyCourseSearch" placeholder="Search academy coursesâ€¦">
    <div class="list-group position-absolute w-100 shadow-sm" id="academyCourseResult" style="z-index:8; max-height:200px; overflow-y:auto; display:none;"></div>
  </div>
  <div id="selected-academy-courses" class="mt-2 d-flex flex-wrap gap-2">
    {% for link in plan.coaching_plan_courses %}
      <span class="badge bg-dark d-flex align-items-center">
        {{ link.course.title }}
        <!-- This shows existing links; removal UI is optional -->
      </span>
    {% endfor %}
  </div>
</div>




        <div class="d-grid mt-4">
          <button class="btn btn-primary btn-lg">ðŸ’¾â€¯Saveâ€¯Changes</button>
        </div>
      </form>

      <hr class="my-4">

      <!-- Progress link -->
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Monitorâ€¯Progress</h5>
        <a href="{{ url_for('coaching.plan_progress', plan_id=plan.id) }}"
           class="btn btn-outline-success">ðŸ“Šâ€¯Viewâ€¯Progress</a>
      </div>

    </div>
  </div>
</div>

{# -------------------- [START] Add JavaScript for Autocomplete and Tagging -------------------- #}
<script>
function enableAutocomplete(inputId, url, resultsId, selectedContainerId, hiddenInputName, isSingleSelect = false) {
    const input = document.getElementById(inputId);
    const results = document.getElementById(resultsId);
    const container = document.getElementById(selectedContainerId);
    const hiddenInput = isSingleSelect ? document.getElementById(hiddenInputName) : null;

    input.addEventListener("input", () => {
        const q = input.value.trim();
        if (q.length < 2) {
            results.style.display = "none";
            return;
        }
        fetch(`${url}?q=${encodeURIComponent(q)}`)
            .then(r => r.json())
            .then(data => {
                results.innerHTML = "";
                if (!data.length) {
                    results.style.display = "none";
                    return;
                }
                data.forEach(row => {
                    const li = document.createElement("li");
                    li.className = "list-group-item list-group-item-action";
                    li.textContent = isSingleSelect ? row.text : row.title;
                    li.addEventListener("click", () => {
                        if (isSingleSelect) {
                            addSingleItem(container, hiddenInput, row.id, row.text);
                        } else {
                            addItem(selectedContainerId, hiddenInputName, row.id, row.title);
                        }
                        input.value = "";
                        results.style.display = "none";
                    });
                    results.appendChild(li);
                });
                results.style.display = "block";
            });
    });
}

function addSingleItem(container, hiddenInput, id, text) {
    container.innerHTML = ''; // Clear previous selection
    const badge = document.createElement("span");
    badge.className = "badge bg-primary d-flex align-items-center";
    badge.innerHTML = `${text} <button type="button" class="btn-close ms-2" onclick="removeSingleItem(this, '${container.id}', '${hiddenInput.id}')"></button>`;
    container.appendChild(badge);
    hiddenInput.value = id;
}

function removeSingleItem(button, containerId, hiddenInputId) {
    document.getElementById(containerId).innerHTML = '';
    document.getElementById(hiddenInputId).value = '';
}

function addItem(containerId, name, id, title) {
    const container = document.getElementById(containerId);
    // Prevent adding duplicates
    if (container.querySelector(`input[value="${id}"]`)) return;

    const badge = document.createElement("span");
    const bgColor = name === 'items' ? 'bg-info text-dark' : 'bg-secondary';
    badge.className = `badge ${bgColor} d-flex align-items-center`;
    badge.innerHTML = `
        ${title}
        <button type="button" class="btn-close ms-2" onclick="removeItem(this, '${name}', ${id})"></button>
        <input type="hidden" name="${name}" value="${id}">
    `;
    container.appendChild(badge);
}

function removeItem(button, name, id) {
    button.parentElement.remove();
}

enableAutocomplete("courseSearch", "/coaching/search_courses", "courseResult", "selected-courses", "items");
enableAutocomplete("testSearch", "/coaching/search_tests", "testResult", "selected-tests", "tests");
enableAutocomplete("user-search-box", "/coaching/search_users", "user-search-results", "selected-user-tag", "assigned_to_hidden", true);
  enableAutocomplete("academyCourseSearch",
                     "/coaching/search_academy_courses",
                     "academyCourseResult",
                     "selected-academy-courses",
                     "academy_courses");



</script>
{# -------------------- [END] Add JavaScript for Autocomplete and Tagging -------------------- #}
{% endblock %}