{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>ğŸâ€¯Liveâ€¯Resultsâ€¯â€”â€¯{{ test.title }}</h2>
  <p class="text-muted">
    Submissionâ€¯byâ€¯<strong>{{ submission.user.username }}</strong>
    |â€¯{{ submission.submitted_at.strftime("%Yâ€‘%mâ€‘%dâ€¯%H:%M") }}
  </p>

  <!-- Score Summary -->
  <table class="table table-bordered w-auto">
    <tr><th>Totalâ€¯Questions</th><td id="totalQ">{{ total_questions }}</td></tr>
    <tr><th>Averageâ€¯Scoreâ€¯(allâ€¯users)</th><td id="avgScore">{{ "%.1f"|format(avg_score or 0) }}</td></tr>
    <tr><th>Yourâ€¯Score</th><td id="yourScore">{{ "%.1f"|format(submission.score or 0) }}</td></tr>
    <tr><th>Percent</th><td id="percentScore">â€“</td></tr>
  </table>

  <div class="mt-3 d-flex align-items-center gap-3">
    <button id="refreshBtn" class="btn btn-outline-info">ğŸ”„â€¯Refresh</button>
    <span id="lastUpdated" class="text-muted small"></span>
  </div>

  <hr>
  <h4>ğŸ“Šâ€¯Questionâ€¯Performance</h4>
  <ul class="list-group" id="answersList">
    {% for ans in submission.answers %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>{{ loop.index }}.&nbsp;{{ ans.question.question }}</div>
        {% if ans.question.type == "mcq" %}
          {% if ans.is_correct %}
            <span class="text-success">âœ“â€¯+5</span>
          {% else %}
            <span class="text-danger">âœ—â€¯+0</span>
          {% endif %}
        {% elif ans.question.type in ("short_text","audio") %}
          <span class="text-muted">Manualâ€¯Score:â€¯{{ ans.score or 0 }}</span>
        {% endif %}
      </li>
    {% endfor %}
  </ul>

  <div class="mt-4">
    <a href="{{ url_for('tests.index') }}" class="btn btn-primary">â¬…â€¯Backâ€¯toâ€¯Tests</a>
  </div>
</div>

<script>
(function(){
  const submissionId = {{ submission.id }};
  const refreshMs = 10000;  // 10â€¯seconds

  async function refreshResults(){
    try{
      const res = await fetch(`/tests/submission/${submissionId}/result_data`);
      if(!res.ok) throw new Error("HTTPâ€¯" + res.status);
      const data = await res.json();

      // ---- update summary cells ----
      const qs = sel=>document.querySelector(sel);
      qs("#totalQ").textContent   = data.total_questions;
      qs("#avgScore").textContent = data.avg_score;
      qs("#yourScore").textContent = data.your_score;
      qs("#percentScore").textContent = data.percent + "%";

      // ---- rebuild question list ----
      const list = qs("#answersList");
      list.innerHTML = "";
      data.answers.forEach(a=>{
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
          <div>${a.index}.â€¯${a.text}</div>
          ${
            a.type === "mcq"
              ? (a.is_correct ? '<span class="text-success">âœ“â€¯+5</span>' : '<span class="text-danger">âœ—â€¯+0</span>')
              : `<span class="text-muted">Manualâ€¯Score:â€¯${a.score}</span>`
          }
        `;
        list.appendChild(li);
      });

      const ts = document.getElementById("lastUpdated");
      if(ts){ ts.textContent = "Lastâ€¯updatedâ€¯" + new Date().toLocaleTimeString(); }

    }catch(err){
      console.warn("Refresh failedâ€¯â†’â€¯", err);
      const ts = document.getElementById("lastUpdated");
      if(ts){ ts.textContent = "âš â€¯Refreshâ€¯error â€”â€¯" + new Date().toLocaleTimeString(); }
    }
  }

  // manual + auto refresh + focus comeback
  document.getElementById("refreshBtn").addEventListener("click", refreshResults);
  setInterval(refreshResults, refreshMs);
  document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) refreshResults(); });

  // initial auto-run
  refreshResults();
})();
</script>
{% endblock %}