{# app/templates/tests/grade_submission.html #}
{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Grade Submission â€” {{ submission.user.username }}</h2>
  <p class="text-muted">
     Test: {{ submission.test.title }} |
     Submitted: {{ submission.submitted_at | tz("%Y-%m-%d %H:%M") }}
  </p>

  <form method="POST">
    {% for ans in submission.answers %}
      <div class="card mb-3 p-3 shadow-sm">
        <h5>Q{{ loop.index }}. {{ ans.question.question | safe }}</h5>
        <p><small class="text-muted">{{ ans.question.type|capitalize }}</small></p>

        {% if ans.question.media_path %}
          <div class="my-2">
            {% set ext = ans.question.media_path.lower() %}
            {% if ext.endswith(('.mp4','.mov','.webm','.mkv')) %}
              <video class="media-player" controls width="320">
                <source src="{{ url_for('tests.question_media', filename=ans.question.media_path) }}" type="video/mp4">
              </video>
            {% elif ext.endswith(('.mp3','.wav','.ogg')) %}
              <audio controls class="w-100 mt-2">
                <source src="{{ url_for('tests.question_media', filename=ans.question.media_path) }}">
              </audio>
            {% elif ext.endswith(('.jpg','.jpeg','.png','.gif','.webp')) %}
              <img src="{{ url_for('tests.question_media', filename=ans.question.media_path) }}" class="img-fluid" style="max-width: 240px;">
            {% else %}
              <a href="{{ url_for('tests.question_media', filename=ans.question.media_path) }}"
                 target="_blank">ðŸ“Žâ€¯{{ ans.question.media_path }}</a>
            {% endif %}
          </div>
        {% endif %}


        {% if ans.question.type == 'mcq' %}
          <ul class="list-unstyled">
            {% for opt in ans.question.options %}
              <li class="{% if opt.id == ans.selected_option %}fw-bold{% endif %}">
                {{ opt.text }}
                {% if opt.is_correct %}<span class="badge bg-success ms-2">âœ“ Correct</span>{% endif %}
                {% if opt.id == ans.selected_option and not opt.is_correct %}<span class="badge bg-danger ms-2">âœ— Selected</span>{% endif %}
              </li>
            {% endfor %}
          </ul>
          <div>
            {% if ans.is_correct %}
              <span class="badge bg-success fs-6">ðŸŸ¢&nbsp;5&nbsp;/&nbsp;5</span>
            {% else %}
              <span class="badge bg-danger fs-6">ðŸ”´&nbsp;0&nbsp;/&nbsp;5</span>
            {% endif %}
          </div>

        {% elif ans.question.type == 'short_text' %}
          <div class="border p-2 bg-light rounded">
            <strong>Response:</strong><br>{{ ans.answer_text or "â€” none â€”" }}
          </div>
          <div class="mt-2">
            <label class="form-label">Mark (0â€“5):</label>
            <input type="number" step="0.1" min="0" max="5"
                   name="q_{{ ans.id }}"
                   value="{{ ans.score or '0' }}"
                   class="form-control w-auto d-inline-block">
          </div>

        {% elif ans.question.type == 'audio' %}
          {% if ans.answer_audio %}
            <audio controls class="w-100">
              <source src="{{ url_for('presentations.media_file', filename='audio_answers/' ~ ans.answer_audio) }}">
              Your browser does not support the audio element.
            </audio>
          {% else %}
            <p class="text-muted">â€”â€¯no audio submittedâ€¯â€”</p>
          {% endif %}
          <div class="mt-2">
            <label class="form-label">Mark (0â€“5):</label>
            <input type="number" step="0.1" min="0" max="5"
                   name="q_{{ ans.id }}"
                   value="{{ ans.score or '0' }}"
                   class="form-control w-auto d-inline-block">
          </div>
        {% endif %}
      </div>
    {% endfor %}

    <button type="submit" class="btn btn-success">Save Grades</button>
    <a href="{{ url_for('tests.review_submissions', test_id=submission.test.id) }}"
       class="btn btn-secondary">Cancel</a>
  </form>
</div>
{% endblock %}