{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <a href="{{ url_for('library.index') }}" class="btn btn-secondary mb-3">&larr; Back</a>
  <h2>{{ item.title }}</h2>

  {% if current_user.role in ["MANAGER","ADMIN","SUPER_ADMIN"] %}
    <a href="{{ url_for('library.edit_item', item_id=item.id) }}" class="btn btn-warning btn-sm">Edit</a>
    <form method="POST" action="{{ url_for('library.archive_item', item_id=item.id) }}" style="display:inline;">
      <button class="btn btn-outline-secondary btn-sm" onclick="return confirm('Archive this item?')">Archive</button>
    </form>
    {% if current_user.role in ["ADMIN","SUPER_ADMIN"] %}
    <form method="POST" action="{{ url_for('library.delete_item', item_id=item.id) }}" style="display:inline;">
      <button class="btn btn-danger btn-sm" onclick="return confirm('Delete permanently?')">Delete</button>
    </form></br>
    {% endif %}
  {% endif %}
<!-- Main File -->
{% if "video" in item.mime %}
  <video controls width="100%">
    <source src="{{ url_for('library.download_item', item_id=item.id) }}" type="{{ item.mime }}">
  </video>
  <div class="mt-2">
    <a href="{{ url_for('library.download_item', item_id=item.id) }}" class="btn btn-outline-secondary">
      ‚¨áÔ∏è Download Video
    </a>
  </div>

{% elif "audio" in item.mime %}
  <audio controls style="width:100%">
    <source src="{{ url_for('library.download_item', item_id=item.id) }}" type="{{ item.mime }}">
  </audio>
  <div class="mt-2">
    <a href="{{ url_for('library.download_item', item_id=item.id) }}" class="btn btn-outline-secondary">
      ‚¨áÔ∏è Download Audio
    </a>
  </div>

{% elif "image" in item.mime %}
  <img src="{{ url_for('library.download_item', item_id=item.id) }}" class="img-fluid">
  <div class="mt-2">
    <a href="{{ url_for('library.download_item', item_id=item.id) }}" class="btn btn-outline-secondary">
      ‚¨áÔ∏è Download Image
    </a>
  </div>

{% elif "pdf" in item.mime %}
  <iframe src="{{ url_for('library.download_item', item_id=item.id) }}" width="100%" height="600px"></iframe>
  <div class="mt-2">
    <a href="{{ url_for('library.download_item', item_id=item.id) }}" class="btn btn-outline-secondary">
      ‚¨áÔ∏è Download PDF
    </a>
  </div>

{% elif "word" in item.mime or item.filename.endswith(('.docx','.doc')) %}
  <iframe src="https://view.officeapps.live.com/op/embed.aspx?src={{ url_for('library.download_item', item_id=item.id, _external=True) }}" 
          width="100%" height="600px"></iframe>
  <div class="mt-2">
    <a href="{{ url_for('library.download_item', item_id=item.id) }}" class="btn btn-outline-secondary">
      ‚¨áÔ∏è Download Word Doc
    </a>
  </div>

{% elif "excel" in item.mime or item.filename.endswith(('.xls','.xlsx')) %}
  <iframe src="https://view.officeapps.live.com/op/embed.aspx?src={{ url_for('library.download_item', item_id=item.id, _external=True) }}" 
          width="100%" height="600px"></iframe>
  <div class="mt-2">
    <a href="{{ url_for('library.download_item', item_id=item.id) }}" class="btn btn-outline-secondary">
      ‚¨áÔ∏è Download Spreadsheet
    </a>
  </div>

{% elif "presentation" in item.mime or item.filename.endswith(('.pptx','.ppt')) %}
  <iframe src="https://view.officeapps.live.com/op/embed.aspx?src={{ url_for('library.download_item', item_id=item.id, _external=True) }}" 
          width="100%" height="600px"></iframe>
  <div class="mt-2">
    <a href="{{ url_for('library.download_item', item_id=item.id) }}" class="btn btn-outline-secondary">
      ‚¨áÔ∏è Download Presentation
    </a>
  </div>

{% else %}
  <a href="{{ url_for('library.download_item', item_id=item.id) }}" class="btn btn-outline-secondary">
    Download {{ item.filename }}
  </a>
{% endif %}

  <!-- Attachments -->
  {% if item.attachments %}
  <h4 class="mt-4">Attachments</h4>
  <div class="row">
    {% for a in item.attachments %}
    <div class="col-md-6 mb-3">
      <p><strong>{{ a.filename }}</strong></p>
      {% if "video" in a.mime %}
        <video controls width="100%">
          <source src="{{ url_for('library.download_attachment', attach_id=a.id) }}" type="{{ a.mime }}">
        </video>
      {% elif "audio" in a.mime %}
        <audio controls style="width:100%">
          <source src="{{ url_for('library.download_attachment', attach_id=a.id) }}" type="{{ a.mime }}">
        </audio>
      {% elif "image" in a.mime %}
        <img src="{{ url_for('library.download_attachment', attach_id=a.id) }}" class="img-fluid">
      {% elif "pdf" in a.mime %}
        <iframe src="{{ url_for('library.download_attachment', attach_id=a.id) }}" width="100%" height="400px"></iframe>
      {% else %}
        <a href="{{ url_for('library.download_attachment', attach_id=a.id) }}" class="btn btn-outline-secondary">{{ a.filename }}</a>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <p>{{ item.description }}</p>


{% if current_user.role in ["ADMIN","SUPER_ADMIN"] %}
    <div class="mb-2">
  <form method="POST" action="{{ url_for('library.mark_trending', item_id=item.id) }}" class="d-inline">
    <button class="btn btn-sm btn-outline-warning">‚≠ê Highlight</button>
  </form>

  <form method="POST" action="{{ url_for('library.unmark_trending', item_id=item.id) }}" class="d-inline">
    <button class="btn btn-sm btn-outline-secondary">‚ùå Unhighlight</button>
  </form>
   </div>
{% endif %}


  <!-- üìù Feedback -->
  <h3>Feedback</h3>
  <form method="POST" action="{{ url_for('library.feedback', item_id=item.id) }}" class="mb-3">
    <div class="mb-2">
      <label class="form-label me-2">Easy:</label>
      <div class="star-rating">
        {% for i in range(5,0,-1) %}
          <input type="radio" id="easy{{i}}" name="easy" value="{{i}}">
          <label for="easy{{i}}">‚òÖ</label>
        {% endfor %}
      </div>
    </div>

    <div class="mb-2">
      <label class="form-label me-2">Complete:</label>
      <div class="star-rating">
        {% for i in range(5,0,-1) %}
          <input type="radio" id="complete{{i}}" name="complete" value="{{i}}">
          <label for="complete{{i}}">‚òÖ</label>
        {% endfor %}
      </div>
    </div>

    <div class="mb-2">
      <label class="form-label me-2">Overall:</label>
      <div class="star-rating">
        {% for i in range(5,0,-1) %}
          <input type="radio" id="overall{{i}}" name="overall" value="{{i}}">
          <label for="overall{{i}}">‚òÖ</label>
        {% endfor %}
      </div>
    </div>

    {% if item.allow_comments %}
    <div class="mb-3">
      <label class="form-label">Comment:</label>
      <textarea class="form-control" name="comment"></textarea>
    </div>
    {% endif %}

    <button class="btn btn-primary">Submit Rating</button>
  </form>

  {% if item.ratings %}
    {% set avg_easy = (item.ratings | map(attribute='easy') | sum) / (item.ratings|length) %}
    {% set avg_complete = (item.ratings | map(attribute='complete') | sum) / (item.ratings|length) %}
    {% set avg_overall = (item.ratings | map(attribute='overall') | sum) / (item.ratings|length) %}
  {% endif %}

  {% macro show_stars(value) %}
    {% set rounded = (value * 2)|round / 2 %}
    <span class="stars">
      {% for i in range(1,6) %}
        {% if i <= rounded %}
          <i class="bi bi-star-fill text-warning"></i>
        {% elif i - 0.5 == rounded %}
          <i class="bi bi-star-half text-warning"></i>
        {% else %}
          <i class="bi bi-star text-muted"></i>
        {% endif %}
      {% endfor %}
    </span>
  {% endmacro %}

  <h3 class="mt-4">Reviews</h3>
  {% if item.ratings %}
    <div class="mb-3">
      <strong>Easy:</strong> {{ show_stars(avg_easy) }}<br>
      <strong>Complete:</strong> {{ show_stars(avg_complete) }}<br>
      <strong>Overall:</strong> {{ show_stars(avg_overall) }}
    </div>

    <!-- Scrollable comments -->
    <div class="border rounded p-2 bg-light" style="max-height:250px; overflow-y:auto;">
      {% for r in item.ratings | selectattr("comment") | list %}
        <div class="mb-2 pb-2 border-bottom small">
          <strong>{{ r.user.username or r.user.email }}</strong>
          <span class="text-muted">({{ r.created_at.strftime("%Y-%m-%d") }})</span><br>
          {{ r.comment }}
        </div>
      {% else %}
        <p class="text-muted">No comments left yet.</p>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">No feedback yet</p>
  {% endif %}

  <style>
    .star-rating { direction: rtl; display: inline-flex; }
    .star-rating input[type=radio] { display: none; }
    .star-rating label { font-size: 1.5rem; color: #ccc; cursor: pointer; }
    .star-rating input:checked ~ label { color: gold; }
    .star-rating label:hover, .star-rating label:hover ~ label { color: gold; }
    .stars { font-size: 1.4rem; }
  </style>

  <!-- üìñ FAQs -->
  <h3 class="mt-4">FAQs</h3>
  <ul>
    {% for f in item.faqs %}
      <li><b>{{ f.question }}</b>: {{ f.answer }}</li>
    {% endfor %}
  </ul>
  {% if current_user.role in ["MANAGER","ADMIN","SUPER_ADMIN"] %}
  <form method="POST" action="{{ url_for('library.add_faq', item_id=item.id) }}" class="mt-2">
    <input class="form-control mb-2" name="question" placeholder="Question" required>
    <textarea class="form-control mb-2" name="answer" placeholder="Answer" required></textarea>
    <button type="submit" class="btn btn-success">Add FAQ</button>
  </form>
  {% endif %}

  <!-- üìù Quiz -->
  <h3 class="mt-4">Quiz</h3>
  <form method="POST" action="{{ url_for('library.quiz_submit', item_id=item.id) }}">
    {% for q in item.quiz_questions %}
      <p><strong>{{ q.question }}</strong></p>
      {% for opt in q.options %}
      <div>
        <label><input type="radio" name="q{{ q.id }}" value="{{ opt.id }}"> {{ opt.text }}</label>
      </div>
      {% endfor %}
    {% endfor %}
    <button type="submit" class="btn btn-primary mt-2">Submit Quiz</button>
  </form>
  {% if current_user.role in ["MANAGER","ADMIN","SUPER_ADMIN"] %}
    <a class="btn btn-outline-success mt-3" href="{{ url_for('library.add_quiz_question', item_id=item.id) }}">Add Quiz Question</a>
  {% endif %}

  <!-- ‚öñÔ∏è Bias control -->
  {% if current_user.role in ["ADMIN","SUPER_ADMIN"] %}
  <h4 class="mt-4">Bias Control</h4>
  <form method="POST" action="{{ url_for('library.set_bias', item_id=item.id) }}" class="mb-2">
    <div class="input-group">
      <input class="form-control" type="number" step="0.1" name="bias" value="{{ item.bias_weight }}">
      <button class="btn btn-outline-primary">Set Global Bias</button>
    </div>
  </form>
  <form method="POST" action="{{ url_for('library.set_team_bias', item_id=item.id) }}" class="mb-2">
    <div class="input-group">
      <select class="form-select" name="team_id">
        {% for t in all_teams %}<option value="{{ t.id }}">{{ t.name }}</option>{% endfor %}
      </select>
      <input class="form-control" type="number" step="0.1" name="bias" placeholder="weight">
      <button class="btn btn-outline-secondary">Set Team Bias</button>
    </div>
  </form>
  <form method="POST" action="{{ url_for('library.set_user_bias', item_id=item.id) }}">
    <div class="input-group">
      <input class="form-control" type="number" name="user_id" placeholder="User ID">
      <input class="form-control" type="number" step="0.1" name="bias" placeholder="weight">
      <button class="btn btn-outline-secondary">Set User Bias</button>
    </div>
  </form>
  {% endif %}
</div>

<script>
let start = Date.now();
window.addEventListener("beforeunload", () => {
  const duration = Math.round((Date.now() - start) / 1000);
  navigator.sendBeacon("{{ url_for('library.end_session', item_id=item.id) }}", JSON.stringify({duration: duration}));
});
</script>
{% endblock %}